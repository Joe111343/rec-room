<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>多人 P2P 3D + 語音 (重寫)</title>
<style>
body{margin:0;overflow:hidden;}
#ui{position:absolute;top:10px;left:10px;z-index:10;background:rgba(255,255,255,0.8);padding:10px;border-radius:5px;}
audio{display:none;}
</style>
</head>
<body>
<div id="ui">
<button id="startBtn">啟動 P2P</button>
<input type="text" id="peerIdInput" placeholder="輸入對方ID">
<button id="connectBtn">連線</button>
</div>

<script src="https://cdn.jsdelivr.net/npm/peerjs@1.4.7/dist/peerjs.min.js"></script>

<script type="module">
import * as THREE from "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js";
import { PointerLockControls } from "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/controls/PointerLockControls.js";

// --- 基本 Three.js 設定 ---
const scene = new THREE.Scene();
scene.background = new THREE.Color(0x87CEEB);
const camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
const renderer = new THREE.WebGLRenderer({antialias:true});
renderer.setSize(window.innerWidth, window.innerHeight);
document.body.appendChild(renderer.domElement);

const light = new THREE.DirectionalLight(0xffffff,1);
light.position.set(10,20,10);
scene.add(light);
scene.add(new THREE.AmbientLight(0xffffff,0.5));

const floor = new THREE.Mesh(
  new THREE.PlaneGeometry(500,500),
  new THREE.MeshStandardMaterial({color:0x228B22})
);
floor.rotation.x = -Math.PI/2;
scene.add(floor);

// --- 角色生成函數 ---
function createPlayer(color=0xff0000){
    const group = new THREE.Group();
    const body = new THREE.Mesh(new THREE.BoxGeometry(1,2,0.5), new THREE.MeshStandardMaterial({color}));
    body.position.y=1; group.add(body);
    const head = new THREE.Mesh(new THREE.BoxGeometry(0.8,0.8,0.8), new THREE.MeshStandardMaterial({color}));
    head.position.y=2.6; group.add(head);
    const leftArm = new THREE.Mesh(new THREE.BoxGeometry(0.3,1,0.3), new THREE.MeshStandardMaterial({color}));
    leftArm.position.set(-0.65,1.5,0); group.add(leftArm);
    const rightArm = leftArm.clone(); rightArm.position.x=0.65; group.add(rightArm);
    const leftLeg = new THREE.Mesh(new THREE.BoxGeometry(0.4,1,0.4), new THREE.MeshStandardMaterial({color}));
    leftLeg.position.set(-0.25,0,0); group.add(leftLeg);
    const rightLeg = leftLeg.clone(); rightLeg.position.x=0.25; group.add(rightLeg);
    scene.add(group);
    return group;
}

// --- 本地玩家 ---
const localPlayer = createPlayer(0x0000ff);
camera.position.set(0,2,5);

// --- 控制器 ---
const controls = new PointerLockControls(camera, document.body);
document.addEventListener('click',()=>controls.lock());

// --- 移動 ---
const move = {forward:0,right:0,up:0};
const velocity = 0.1;
document.addEventListener('keydown', e=>{
    if(e.key==='w') move.forward=1;
    if(e.key==='s') move.forward=-1;
    if(e.key==='a') move.right=-1;
    if(e.key==='d') move.right=1;
    if(e.key===' ') move.up=1;
});
document.addEventListener('keyup', e=>{
    if(e.key==='w'||e.key==='s') move.forward=0;
    if(e.key==='a'||e.key==='d') move.right=0;
    if(e.key===' ') move.up=0;
});

// --- 手柄 ---
function handleGamepad(){
    const pads = navigator.getGamepads();
    for(const pad of pads){
        if(!pad) continue;
        move.forward = pad.axes[1];
        move.right = pad.axes[0];
        controls.rotateLeft(pad.axes[2]*0.05);
        controls.rotateUp(-pad.axes[3]*0.05);
    }
}

// --- P2P 設定 ---
let peer, conn, localStream;
const players = {};

document.getElementById('startBtn').onclick = async ()=>{
    localStream = await navigator.mediaDevices.getUserMedia({audio:true});
    peer = new Peer();
    peer.on('open', id=>alert('你的ID: '+id));
    peer.on('connection', c=>{ conn=c; conn.on('data', handleData); });
    peer.on('call', call=>{
        call.answer(localStream);
        const audio=document.createElement('audio'); audio.autoplay=true;
        call.on('stream', s=>audio.srcObject=s);
        document.body.appendChild(audio);
    });
};

document.getElementById('connectBtn').onclick = ()=>{
    const id = document.getElementById('peerIdInput').value;
    conn = peer.connect(id);
    conn.on('open', ()=>console.log('資料連線成功'));
    conn.on('data', handleData);
    const call = peer.call(id, localStream);
    const audio=document.createElement('audio'); audio.autoplay=true;
    call.on('stream', s=>audio.srcObject=s);
    document.body.appendChild(audio);
};

function handleData(data){
    const {id,pos,rot} = data;
    if(!players[id]) players[id] = createPlayer(0xff0000);
    players[id].position.set(pos.x,pos.y,pos.z);
    players[id].rotation.set(rot._x,rot._y,rot._z);
}

function sendData(){
    if(conn && conn.open){
        conn.send({id:peer.id,pos:localPlayer.position,rot:localPlayer.rotation});
    }
}

// --- 更新 ---
function updatePlayer(){
    const dir = new THREE.Vector3();
    dir.z = -move.forward; dir.x = move.right; dir.normalize();
    dir.applyEuler(camera.rotation);
    localPlayer.position.addScaledVector(dir, velocity);
    if(move.up) localPlayer.position.y += velocity;
}

// --- 渲染 ---
function animate(){
    requestAnimationFrame(animate);
    handleGamepad();
    updatePlayer();
    sendData();
    camera.position.lerp(localPlayer.position.clone().add(new THREE.Vector3(0,2,5)),0.1);
    renderer.render(scene,camera);
}
animate();

window.addEventListener('resize', ()=>{
    camera.aspect = window.innerWidth/window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth, window.innerHeight);
});
</script>
</body>
</html>
